_file_name: pageview_engagement.yaml
always_filter_main_dttm: false
cache_timeout: null
columns:
- advanced_data_type: null
  column_name: course_key
  description: null
  expression: ''
  extra: {}
  filterable: true
  groupby: true
  is_active: true
  is_dttm: false
  python_date_format: null
  type: LowCardinality(String)
  verbose_name: Course Key
- advanced_data_type: null
  column_name: actor_id
  description: null
  expression: ''
  extra: {}
  filterable: true
  groupby: true
  is_active: true
  is_dttm: false
  python_date_format: null
  type: String
  verbose_name: Actor Id
- advanced_data_type: null
  column_name: content_level
  description: null
  expression: ''
  extra: {}
  filterable: true
  groupby: true
  is_active: true
  is_dttm: false
  python_date_format: null
  type: String
  verbose_name: Content Level
- advanced_data_type: null
  column_name: course_run
  description: null
  expression: ''
  extra: {}
  filterable: true
  groupby: true
  is_active: true
  is_dttm: false
  python_date_format: null
  type: String
  verbose_name: Course Run
- advanced_data_type: null
  column_name: org
  description: null
  expression: ''
  extra: {}
  filterable: true
  groupby: true
  is_active: true
  is_dttm: false
  python_date_format: null
  type: LowCardinality(String)
  verbose_name: Org
- advanced_data_type: null
  column_name: email
  description: null
  expression: ''
  extra: {}
  filterable: true
  groupby: true
  is_active: true
  is_dttm: false
  python_date_format: null
  type: String
  verbose_name: Email
- advanced_data_type: null
  column_name: name
  description: null
  expression: ''
  extra: {}
  filterable: true
  groupby: true
  is_active: true
  is_dttm: false
  python_date_format: null
  type: String
  verbose_name: Name
- advanced_data_type: null
  column_name: username
  description: null
  expression: ''
  extra: {}
  filterable: true
  groupby: true
  is_active: true
  is_dttm: false
  python_date_format: null
  type: String
  verbose_name: Username
- advanced_data_type: null
  column_name: section_subsection_page_engagement
  description: null
  expression: ''
  extra: {}
  filterable: true
  groupby: true
  is_active: true
  is_dttm: false
  python_date_format: null
  type: String
  verbose_name: section_subsection_page_engagement
- advanced_data_type: null
  column_name: section_subsection_name
  description: null
  expression: ''
  extra: {}
  filterable: true
  groupby: true
  is_active: true
  is_dttm: false
  python_date_format: null
  type: String
  verbose_name: section_subsection_name
database_uuid: 21174b6c-4d40-4958-8161-d6c3cf5e77b6
default_endpoint: null
description: null
extra: null
fetch_values_predicate: null
filter_select_enabled: false
main_dttm_col: null
metrics:
- currency: null
  d3format: null
  description: null
  expression: |-
    countIf("section_subsection_page_engagement" = 'At least one page viewed' or "section_subsection_page_engagement" = 'All pages viewed')
  extra:
    warning_markdown: ''
  metric_name: at_leat_one_page_viewed
  metric_type: null
  verbose_name: Viewed At Least One Page
  warning_text: null
- currency: null
  d3format: null
  description: null
  expression: |-
    countIf("section_subsection_page_engagement" = 'All pages viewed')
  extra:
    warning_markdown: ''
  metric_name: all_pages_viewed
  metric_type: null
  verbose_name: Viewed All Pages
  warning_text: null
- currency: null
  d3format: null
  description: null
  expression: count(*)
  extra:
    warning_markdown: ''
  metric_name: count
  metric_type: null
  verbose_name: Count
  warning_text: null
normalize_columns: true
offset: 0
params: null
schema: 'reporting'
sql: |
  with
      subsection_engagement as (
          select
              org,
              course_key,
              'subsection' as content_level,
              actor_id,
              subsection_block_id as block_id,
              engagement_level as section_subsection_page_engagement
          from reporting.fact_subsection_page_engagement
          where 1 = 1 {% if filter_values("org") != [] %}
      and org in {{ filter_values("org") | where_in }}
  {% endif %}

  {% if filter_values("course_name") != [] %}
      and course_key in (
          select course_key
          from event_sink.dim_course_names
          where course_name in {{ filter_values("course_name") | where_in }}
      )
  {% endif %}

  {% if filter_values("tag") != [] %}
      and course_key in (
          select course_key
          from
              reporting.dim_most_recent_course_tags
          where
              tag in (select replaceAll(arrayJoin({{ filter_values("tag") }}), '- ', ''))
      )
  {% endif %}
      ),
      section_engagement as (
          select
              org,
              course_key,
              'section' as content_level,
              actor_id,
              section_block_id as block_id,
              engagement_level as section_subsection_page_engagement
          from reporting.fact_section_page_engagement
      ),
      page_engagement as (
          select *
          from subsection_engagement
          union all
          select *
          from section_engagement
      )

  select
      pv.org as org,
      pv.course_key as course_key,
      course_blocks.course_run as course_run,
      course_blocks.display_name_with_location as section_subsection_name,
      pv.content_level as content_level,
      pv.actor_id as actor_id,
      pv.section_subsection_page_engagement as section_subsection_page_engagement,
      users.username as username,
      users.name as name,
      users.email as email
  from page_engagement pv
  join
      reporting.dim_course_blocks course_blocks
      on (
          pv.org = course_blocks.org
          and pv.course_key = course_blocks.course_key
          and pv.block_id = course_blocks.block_id
      )
  left outer join
      reporting.dim_user_pii users
      on (pv.actor_id like 'mailto:%' and SUBSTRING(pv.actor_id, 8) = users.email)
      or pv.actor_id = toString(users.external_user_id)
  where 1 = 1 {% if filter_values("org") != [] %}
      and org in {{ filter_values("org") | where_in }}
  {% endif %}

  {% if filter_values("course_name") != [] %}
      and course_key in (
          select course_key
          from event_sink.dim_course_names
          where course_name in {{ filter_values("course_name") | where_in }}
      )
  {% endif %}

  {% if filter_values("tag") != [] %}
      and course_key in (
          select course_key
          from
              reporting.dim_most_recent_course_tags
          where
              tag in (select replaceAll(arrayJoin({{ filter_values("tag") }}), '- ', ''))
      )
  {% endif %}
table_name: pageview_engagement
template_params: {}
uuid: 9febd6be-5102-4dbf-86b9-45ebd3cbbc45
version: 1.0.0